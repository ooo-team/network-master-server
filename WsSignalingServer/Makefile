# Makefile for WebSocket Signaling Server

# Variables
IMAGE_NAME = signaling-server
CONTAINER_NAME = signaling-server
TAG = latest
PORT = 8080

# Default target
.PHONY: help
help:
	@echo "Available commands:"
	@echo "  make build     - Build Docker image"
	@echo "  make run       - Run container (detached)"
	@echo "  make stop      - Stop container"
	@echo "  make restart   - Restart container"
	@echo "  make logs      - Show container logs"
	@echo "  make update    - Build and restart (full update)"
	@echo "  make clean     - Remove container and image"
	@echo "  make status    - Show container status"

# Build Docker image
.PHONY: build
build:
	@echo "ğŸ”¨ Building Docker image..."
	docker build -t $(IMAGE_NAME):$(TAG) .
	@echo "âœ… Image built successfully: $(IMAGE_NAME):$(TAG)"

# Run container in detached mode
.PHONY: run
run:
	@echo "ğŸš€ Starting container..."
	docker run -d \
		--name $(CONTAINER_NAME) \
		-p $(PORT):$(PORT) \
		--restart unless-stopped \
		$(IMAGE_NAME):$(TAG)
	@echo "âœ… Container started: $(CONTAINER_NAME)"

# Stop container
.PHONY: stop
stop:
	@echo "ğŸ›‘ Stopping container..."
	-docker stop $(CONTAINER_NAME)
	@echo "âœ… Container stopped"

# Remove container
.PHONY: rm
rm:
	@echo "ğŸ—‘ï¸  Removing container..."
	-docker rm $(CONTAINER_NAME)
	@echo "âœ… Container removed"

# Restart container
.PHONY: restart
restart: stop rm run
	@echo "ğŸ”„ Container restarted"

# Show container logs
.PHONY: logs
logs:
	@echo "ğŸ“‹ Container logs:"
	docker logs -f $(CONTAINER_NAME)

# Show container status
.PHONY: status
status:
	@echo "ğŸ“Š Container status:"
	docker ps -a --filter name=$(CONTAINER_NAME)

# Full update: build and restart
.PHONY: update
update:
	@echo "ğŸ”„ Full update: building and restarting..."
	$(MAKE) build
	$(MAKE) restart
	@echo "âœ… Update completed!"

# Clean everything
.PHONY: clean
clean:
	@echo "ğŸ§¹ Cleaning up..."
	$(MAKE) stop
	$(MAKE) rm
	-docker rmi $(IMAGE_NAME):$(TAG)
	@echo "âœ… Cleanup completed"

# Quick deploy (build + run if not exists, restart if exists)
.PHONY: deploy
deploy:
	@echo "ğŸš€ Deploying signaling server..."
	@if docker ps -a --filter name=$(CONTAINER_NAME) --format "{{.Names}}" | grep -q $(CONTAINER_NAME); then \
		echo "ğŸ“¦ Container exists, updating..."; \
		$(MAKE) update; \
	else \
		echo "ğŸ†• Container doesn't exist, creating..."; \
		$(MAKE) build; \
		$(MAKE) run; \
	fi
	@echo "âœ… Deployment completed!"

# Development mode (run with volume mount for live code changes)
.PHONY: dev
dev:
	@echo "ğŸ”§ Starting development mode..."
	-docker stop $(CONTAINER_NAME)-dev 2>/dev/null || true
	-docker rm $(CONTAINER_NAME)-dev 2>/dev/null || true
	docker run -d \
		--name $(CONTAINER_NAME)-dev \
		-p $(PORT):$(PORT) \
		-v $(PWD):/app \
		-w /app \
		--restart unless-stopped \
		golang:1.21-alpine sh -c "go mod download && go run ."
	@echo "âœ… Development container started: $(CONTAINER_NAME)-dev"

# Show all containers
.PHONY: ps
ps:
	@echo "ğŸ“‹ All containers:"
	docker ps -a

# Show images
.PHONY: images
images:
	@echo "ğŸ–¼ï¸  Available images:"
	docker images | grep $(IMAGE_NAME) 